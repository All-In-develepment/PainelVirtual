{% extends "layouts/app.html" %}

{% block title %}Jogos Estrela Bet{% endblock %}

{% block body %}
	<div class="content-wrapper">
		<div class="row">
			<div class="page-header col-12">
				<div class="row col-12">
					<center>
						<a href="#" onclick="selectCampeonato('1')">
							<img src="{{ url_for('static', filename='images/flags/italy.png') }}" alt="flag italiano" width="60" />
						</a>
						<a href="#" onclick="selectCampeonato('2')">
							<img src="{{ url_for('static', filename='images/flags/england.png') }}" alt="flag inglês" width="60" />
						</a>
						<a href="#" onclick="selectCampeonato('3')">
							<img src="{{ url_for('static', filename='images/flags/spain.png') }}" alt="flag espanhol" width="60" />
						</a>
					</center>
				</div>
			</div>

			<div class="page-header col-12">
				<div class="row">
					<form id="paramForm" class="forms-sample">
						<div class="form-group">
							<label for="mercado">Mercado:</label>
							<select id="mercado" name="mercado" onchange="updateParams()" class="form-select">
								<optgroup label="Over" style="font-weight: bold;">
									<option value="over_0.5">Over 0.5</option>
									<option value="over_1.5">Over 1.5</option>
									<option value="over_2.5" selected>Over 2.5</option>
									<option value="over_3.5">Over 3.5</option>
								</optgroup>
								<optgroup label="Under" style="font-weight: bold;">
									<option value="under_0.5">Under 0.5</option>
									<option value="under_1.5">Under 1.5</option>
									<option value="under_2.5">Under 2.5</option>
									<option value="under_3.5">Under 3.5</option>
								</optgroup>
								<optgroup label="Ambas Marcam" style="font-weight: bold;">
									<option value="ambas_marcam_sim">Ambas Marcam: Sim</option>
									<option value="ambas_marcam_nao">Ambas Marcam: Não</option>
								</optgroup>
								<optgroup label="Par ou Ímpar" style="font-weight: bold;">
									<option value="par">Par</option>
									<option value="impar">Ímpar</option>
								</optgroup>
								<optgroup label="Vencedor">
									<option value="home_win">Casa Vence</option>
									<option value="away_win">Fora Vence</option>
								</optgroup>
								<optgroup label="HT">
									<option value="draw_ht">Empate</option>
								</optgroup>
							</select>
						</div>
					</form>

					<div class="form-group">
						<label for="periodo">Período (horas):</label>
						<select id="periodo" name="periodo" onchange="updateParams()" class="form-select">
							<option value="3">3 horas</option>
							<option value="6">6 horas</option>
							<option value="12">12 horas</option>
							<option value="24" selected>24 horas</option>
							<option value="48">48 horas</option>
						</select>
					</div>
				</div>
			</div>
			<div style="text-align: right;">
				<button id="openModalButton" class="btn btn-inverse-success btn-fw" onclick="openModal()">
					Dectar Padrões
				</button>
			</div>
			
			{% if games != 0 %}
				<div class="row">
					<div class="col-lg-12 grid-margin stretch-card">
						<div class="card">
							<div class="card-body">
								<div class="table-responsive">
									<table class="table table-bordered">
										<thead>
											<tr>
												<th> # </th>
												{% for minutos in games['Minutos'] %}
													<th>{{ minutos['Numero'] }}</th>
												{% endfor %}
											</tr>
										</thead>
										<tbody>
											{% for linha in games['Linhas'] %}
												<tr>
													<td>{{ linha['Hora'] }}</td>
													{% for coluna in linha['Colunas'] %}
														{% if 'SomaGols' in coluna %}
																{% if mercado.startswith('under') %}
																		{% if mercado == 'under_0.5' %}
																				{% if coluna['SomaGolsUnder0_5'] < 0.5 %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% elif mercado == 'under_1.5' %}
																				{% if coluna['SomaGolsUnder1_5'] < 1.5 %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% elif mercado == 'under_2.5' %}
																				{% if coluna['SomaGolsUnder2_5'] < 2.5 %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% elif mercado == 'under_3.5' %}
																				{% if coluna['SomaGolsUnder3_5'] < 3.5 %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% endif %}
																{% elif mercado.startswith('over') %}
																		{% if mercado == 'over_0.5' %}
																				{% if coluna['SomaGols'] > 0.5 %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% elif mercado == 'over_1.5' %}
																				{% if coluna['SomaGols'] > 1.5 %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% elif mercado == 'over_2.5' %}
																				{% if coluna['SomaGols'] > 2.5 %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% elif mercado == 'over_3.5' %}
																				{% if coluna['SomaGols'] > 3.5 %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% endif %}
																{% elif mercado.startswith('ambas_marcam') %}
																		{% if mercado == 'ambas_marcam_sim' %}
																				{% if coluna['AmbasMarcam'] %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% elif mercado == 'ambas_marcam_nao' %}
																				{% if coluna['AmbasMarcamNao'] %}
																						<td style="text-align: center" class="bg-success">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% else %}
																						<td style="text-align: center" class="bg-danger">
																								{{ coluna['Resultado'] }}
																						</td>
																				{% endif %}
																		{% endif %}
																{% elif mercado == 'par' %}
																		{% if coluna['ParOuImpar'] == 'Par' %}
																				<td style="text-align: center" class="bg-success">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% else %}
																				<td style="text-align: center" class="bg-danger">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% endif %}
																{% elif mercado == 'impar' %}
																		{% if coluna['ParOuImpar'] == 'Ímpar' %}
																				<td style="text-align: center" class="bg-success">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% else %}
																				<td style="text-align: center" class="bg-danger">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% endif %}
																{% elif mercado == 'home_win' %}
																		{% if coluna['home_win'] == True %}
																				<td style="text-align: center" class="bg-success">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% else %}
																				<td style="text-align: center" class="bg-danger">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% endif %}
																{% elif mercado == 'away_win' %}
																		{% if coluna['away_win'] == True %}
																				<td style="text-align: center" class="bg-success">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% else %}
																				<td style="text-align: center" class="bg-danger">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% endif %}
																{% elif mercado == 'draw_ht' %}
																		{% if coluna['draw_ht'] == True %}
																				<td style="text-align: center" class="bg-success">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% else %}
																				<td style="text-align: center" class="bg-danger">
																						{{ coluna['Resultado'] }}
																				</td>
																		{% endif %}
																{% endif %}
														{% endif %}
													{% endfor %}
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			{% else %}

				<div class="alert alert-warning" role="alert">
					Nenhum jogo encontrado.
				</div>
			{% endif %}
		</div>
	</div>
	<script>
			function selectCampeonato(campeonatoId) {
				// Armazena o campeonato no localStorage
				localStorage.setItem('campeonato', campeonatoId);

				// Atualiza os parâmetros da URL e recarrega o conteúdo
				updateParams();
			}

			function updateParams() {
				const mercado = document.getElementById('mercado').value;
				const periodo = document.getElementById('periodo').value;
				const campeonato = localStorage.getItem('campeonato') || '1'; // Pega o valor do campeonato do localStorage


				// Armazenar as seleções no localStorage
				localStorage.setItem('mercado', mercado);
				localStorage.setItem('periodo', periodo);
				localStorage.setItem('campeonato', campeonato);

				// Atualiza os parâmetros da URL
				const url = new URL(window.location.href);
				url.searchParams.set('mercado', mercado);
				url.searchParams.set('periodo', periodo);
				url.searchParams.set('campeonato', campeonato);

				// Faz o fetch e atualiza o conteúdo da página
				fetch(url)
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						return response.text();
					})
					.then(html => {
						document.body.innerHTML = html;

						// Restaura os valores selecionados após a atualização do HTML
						document.getElementById('mercado').value = localStorage.getItem('mercado') || 'over2_5';
						document.getElementById('periodo').value = localStorage.getItem('periodo') || '24';
					})
					.catch(error => {
						console.error('There has been a problem with your fetch operation:', error);
					});
			}


	// Quando a página é carregada, restaurar as seleções
	window.onload = function() {
    const storedMercado = localStorage.getItem('mercado');
    const storedPeriodo = localStorage.getItem('periodo');
    const storedCampeonato = localStorage.getItem('campeonato');

    if (storedMercado) {
        document.getElementById('mercado').value = storedMercado;
    }
    if (storedPeriodo) {
        document.getElementById('periodo').value = storedPeriodo;
    }

    // Define o campeonato no localStorage caso não exista
    if (!storedCampeonato) {
        localStorage.setItem('campeonato', '1'); // Italiano como padrão
    }
};

	</script>
	<!-- MODAL -->
	<div id="ligaModal" class="modal" style="display: none;">
		<div class="modal-content">
			<span class="close" id="closeModalButton">&times;</span>
			<h2 id="head-busca"></h2>
			<div id="tabelas"></div>
		</div>
	</div>

<script>
	function openModal(){
		const openModalButton = document.getElementById('openModalButton');
		const closeModalButton = document.getElementById('closeModalButton');
		const modal = document.getElementById('ligaModal');

		let storedMercado = document.getElementById('mercado').selectedOptions[0].textContent
		let storedMercadoChoice = document.getElementById('mercado').value
		let storedPeriodo = document.getElementById('periodo').value
		let storedCampeonato = localStorage.getItem('campeonato');

		const data = {
			"periodo": storedPeriodo,
			"liga": storedCampeonato,
			"over": storedMercadoChoice.includes("over")? 
																storedMercadoChoice.split("_")[1] : null,
			"under": storedMercadoChoice.includes("under") ? 
																storedMercadoChoice.split("_")[1] : null,
			"ambas_sim": storedMercadoChoice.includes("sim") ? 
																storedMercadoChoice.split("_")[2] : null,
			"ambas_nao": storedMercadoChoice.includes("nao") ? 
																storedMercadoChoice.split("_")[2] : null,
			"par": storedMercadoChoice.includes("par") ? 
																storedMercadoChoice : null,
			"impar": storedMercadoChoice.includes("impar") ? 
																storedMercadoChoice : null,
			"home_win": storedMercadoChoice.includes("home") ? 
																storedMercadoChoice : null,
			"away_win": storedMercadoChoice.includes("away") ? 
																storedMercadoChoice : null,
			"draw_ht": storedMercadoChoice.includes("draw_ht") ? 
																storedMercadoChoice : null
		}

		// Define o nome do campeonato baseado no ID
		let campeonatoNome = '';
		switch (storedCampeonato) {
				case '1':
						campeonatoNome = 'Italiano';
						break;
				case '2':
						campeonatoNome = 'Inglês';
						break;
				case '3':
						campeonatoNome = 'Espanhol';
						break;
				default:
						campeonatoNome = 'Desconhecido';
		}

		fetch(`/kirongames/auto-search`, {
			method: 'POST',
			headers: {
					'Content-Type': 'application/json'
			},
			body: JSON.stringify(data),
	})
		.then((response) => response.json())
		.then((data) => {
			document.getElementById('tabelas').innerHTML =
				`<h4> ${campeonatoNome} <h4>` + 
				generateTable(data)})

		document.getElementById('head-busca').innerHTML = `
				Busca Automática - ${storedMercado} - ultimas ${storedPeriodo} horas`

		//document.getElementById('leagueId').innerHTML = storedMercado

		modal.style.display = 'block';
		document.body.style.overflow = 'hidden';
		
		// Fechar o modal ao clicar no "X"
		closeModalButton.addEventListener('click', () => {
			modal.style.display = 'none';
			document.body.style.overflow = 'auto';
		});

		// Fechar o modal ao clicar fora da caixa do modal
		window.addEventListener('click', (event) => {
			if (event.target === modal) {
				modal.style.display = 'none';
				document.body.style.overflow = 'auto';
			}
		});
	}

	function generateTable(data){
		let table = `<table border="1" class="table"><thead>
										<tr>
											<th class="centered">Placar</th>
											<th class="centered">S/Gale</th>
											<th class="centered">1º Gale</th>
											<th class="centered">2º Gale</th>
											<th class="centered">Red</th>
											<th class="centered">Green</th>
											<th class="centered">%</th>
										</tr>
								</thead><tbody>`

		let tableData = jsonToArray(data);
		tableData.sort((a, b) => b.assertividade - a.assertividade); 
		
		tableData.forEach(row => {
			table += `
					<tr>
							<td class="centered">${row.placar}</td>
							<td class="centered">${row["tiro seco"]}</td>
							<td class="centered">${row["primeiro gale"]}</td>
							<td class="centered">${row["segundo gale"]}</td>
							<td class="centered">${row.red}</td>
							<td class="centered">${row.green}</td>
							<td class="centered">${row.assertividade}%</td>
					</tr>
			`;
	});

		table += `</tbody></table>`;

		return table;
	}

	function jsonToArray(data) {
		return Object.keys(data.placar).map(key => ({
				placar: data.placar[key],
				"tiro seco": data["tiro seco"][key],
				"primeiro gale": data["primeiro gale"][key],
				"segundo gale": data["segundo gale"][key],
				red: data["red"][key],
				green: data["green"][key],
				assertividade: data["assertividade"][key]
		}));
}
</script>
	
	<style>
		/* Estilos do modal */
	.modal {
		display: none; /* Inicialmente oculto */
		position: fixed; /* Fica fixo na tela */
		z-index: 1; /* Coloca o modal acima do conteúdo */
		left: 0;
		top: 0;
		width: 100%; /* 100% da largura da tela */
		height: 100%; /* 100% da altura da tela */
		background-color: rgba(0, 0, 0, 0.4); /* Fundo semitransparente */
	}
	
	/* Conteúdo do modal */
	.modal-content {
		background-color: rgba(0, 0, 0, 0.8);
		margin: 15% auto;
		padding: 20px;
		border: 1px solid #888;
		width: 80%; 
		color: aqua;
	}

	/* Botão de fechar (X) */
	.close {
		color: #aaa;
		float: right;
		font-size: 28px;
		font-weight: bold;
	}
	
	.close:hover,
	.close:focus {
		color: black;
		text-decoration: none;
		cursor: pointer;
}

</style>
{% endblock %}
