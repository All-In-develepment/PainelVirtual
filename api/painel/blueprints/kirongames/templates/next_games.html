{% extends "layouts/app.html" %}

{% block title %}
  Jogos Estrela Bet
{% endblock %}
<!-- italy = 1; england = 2; spain = 3 -->
{% block body %}
<div class="row">
  <center>
    <img src="{{ url_for('static', filename='images/flags/italy.png') }}" alt="Italy" width="60" onclick="filterByLeague(1)" style="cursor: pointer;" />
    <img src="{{ url_for('static', filename='images/flags/england.png') }}" alt="England" width="60" onclick="filterByLeague(2)" style="cursor: pointer;" />
    <img src="{{ url_for('static', filename='images/flags/spain.png') }}" alt="Spain" width="60" onclick="filterByLeague(3)" style="cursor: pointer;" />
  </center>
</div>

<div class="button-container">
  <center>
    {% for team, games in games_by_team_future.items() %}
      {% if loop.first %}
        <!-- Guardar os valores do primeiro jogo para execução ao carregar a página -->
        <script>
          let firstTeamA = "{{ games[0].TeamA }}";
          let firstTeamB = "{{ games[0].TeamB }}";
          let firstHorario = "{{ games[0].Horario }}";
        </script>
      {% endif %}
      <button class="btn btn-info" onclick="showGameDetails('{{ games[0].TeamA }}', '{{ games[0].TeamB }}', '{{ games[0].Horario }}')">
        {{ games[0].TeamA }} vs {{ games[0].TeamB }} <br>
        {{ games[0].Horario }}
      </button>
    {% endfor %}
  </center>
</div>

<script>
  // Chamar a função showGameDetails ao carregar a página para o primeiro jogo
  window.onload = function() {
    showGameDetails(firstTeamA, firstTeamB, firstHorario);
  };
</script>

<div id="game-details" style="display:none;">
  <h2>Detalhes do Jogo</h2>
  <div style="display: flex; justify-content: space-between;">
    <div id="team-a-details" style="width: 45%;"></div>
    <div id="team-a-home-details" style="width: 45%;"></div>
  </div>
  <div style="display: flex; justify-content: space-between;">
    <div id="team-b-details" style="width: 45%;"></div>
    <div id="team-b-home-details" style="width: 45%;"></div>
  </div>
</div>

<script>
// Variável global para armazenar o leagueId
let leagueId = 1;  // Valor padrão, por exemplo, para Itália
  
function filterByLeague(selectedLeagueId) {
  leagueId = selectedLeagueId;
  // Limpar os dados anteriores
  document.getElementById('team-a-details').innerHTML = '';
  document.getElementById('team-b-details').innerHTML = '';
  document.getElementById('team-a-home-details').innerHTML = '';
  document.getElementById('team-b-home-details').innerHTML = '';

  // Redirecionar ou fazer nova requisição para carregar a nova liga
  window.location.href = `/kirongames/next-games?campeonato=${leagueId}`;
}

function showGameDetails(teamA, teamB, horario) {
  const currentUrl = window.location.href;

  // Cria um objeto URL a partir da URL atual
  const url = new URL(currentUrl);
  
  // Usa URLSearchParams para obter os parâmetros da URL
  const params = new URLSearchParams(url.search);
  
  // Obtém o valor do parâmetro 'campeonato'
  const campeonatoValue = params.get('campeonato');

  document.getElementById('game-details').style.display = 'block';

  // Limpa os detalhes das tabelas anteriores
  document.getElementById('team-a-details').innerHTML = '';
  document.getElementById('team-b-details').innerHTML = '';
  document.getElementById('team-a-home-details').innerHTML = '';
  document.getElementById('team-b-home-details').innerHTML = '';

  // Aqui, leagueId já está atualizado
  fetch(`/kirongames/get_game_details/${teamA}/${teamB}?campeonato=${campeonatoValue}`)
    .then(response => response.json())
    .then(data => {
      // Adiciona título para Time A com jogos gerais
      document.getElementById('team-a-details').innerHTML = 
          `<h3>${teamA} - Geral</h3>` + generateTable(data.teamA_all);
      
      // Adiciona título para Time A com jogos em casa
      document.getElementById('team-a-home-details').innerHTML = 
          `<h3>${teamA} em casa</h3>` + generateTable(data.teamA);

      // Adiciona título para Time B com jogos gerais
      document.getElementById('team-b-details').innerHTML = 
          `<h3>${teamB} - Geral</h3>` + generateTable(data.teamB_all);

      // Adiciona título para Time B com jogos em casa
      document.getElementById('team-b-home-details').innerHTML = 
          `<h3>${teamB} em casa</h3>` + generateTable(data.teamB);
    });
}

function generateTable(teamData) {
  let table = `<table border="1" class="table"><thead>
                 <tr>
                   <th class="centered">Horário</th>
                   <th class="centered">Time A</th>
                   <th class="centered">Resultado</th>
                   <th class="centered">Time B</th>
                   <th class="centered">Status</th>
                 </tr>
               </thead><tbody>`;
  
  teamData.forEach(game => {
      let statusLabel = '';

      // Condicional para determinar a label do status
      if (game.status === "V") {
          statusLabel = '<span class="label label-success label-as-badge">V</span>';
      } else if (game.status === "E") {
          statusLabel = '<span class="label label-warning label-as-badge">E</span>';
      } else if (game.status === "D") {
          statusLabel = '<span class="label label-danger label-as-badge">D</span>';
      } else {
          statusLabel = '<span class="label label-default label-as-badge">Desconhecido</span>';
      }

      table += `<tr>
                  <td class="centered">${game.Horario}</td>
                  <td class="centered">${game.TeamA}</td>
                  <td class="centered"><b>${game.Resultado}</b></td>
                  <td class="centered">${game.TeamB}</td>
                  <td class="centered">${statusLabel}</td>
                </tr>`;
  });

  table += `</tbody></table>`;
  return table;
}
</script>
{% endblock %}
